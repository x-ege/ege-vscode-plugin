name: release extension

on:
  push:
    tags:
      - '*'
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Determine trigger type
      id: trigger_type
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "is_tag=true" >> $GITHUB_OUTPUT
          echo "is_dry_run=false" >> $GITHUB_OUTPUT
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Triggered by tag: $TAG"
        else
          echo "is_tag=false" >> $GITHUB_OUTPUT
          echo "is_dry_run=true" >> $GITHUB_OUTPUT
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "tag=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "Triggered by master branch push (dry-run mode)"
          echo "Using version from package.json: $PACKAGE_VERSION"
        fi

    - name: Validate tag format and determine release type
      id: validate_tag
      run: |
        TAG="${{ steps.trigger_type.outputs.tag }}"
        IS_DRY_RUN="${{ steps.trigger_type.outputs.is_dry_run }}"
        
        # Check if tag matches stable release pattern (e.g., 1.0.3)
        if echo "$TAG" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "is_stable_release=true" >> $GITHUB_OUTPUT
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
          echo "should_publish=true" >> $GITHUB_OUTPUT
          if [ "$IS_DRY_RUN" == "true" ]; then
            echo "Dry-run: Tag is a stable release pattern: $TAG"
          else
            echo "Tag is a stable release: $TAG"
          fi
        # Check if tag matches pre-release pattern (e.g., 1.0.3-alpha, 1.0.3-beta, 1.0.3-rc.1)
        elif echo "$TAG" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-.+$'; then
          echo "is_stable_release=false" >> $GITHUB_OUTPUT
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
          echo "should_publish=true" >> $GITHUB_OUTPUT
          if [ "$IS_DRY_RUN" == "true" ]; then
            echo "Dry-run: Tag is a pre-release pattern: $TAG"
          else
            echo "Tag is a pre-release: $TAG"
          fi
        else
          echo "is_stable_release=false" >> $GITHUB_OUTPUT
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
          echo "should_publish=false" >> $GITHUB_OUTPUT
          if [ "$IS_DRY_RUN" == "true" ]; then
            echo "Dry-run: Tag does not match release patterns: $TAG"
          else
            echo "Tag does not match release patterns: $TAG"
          fi
          echo "Will only run build and test."
        fi

    - name: Extract version from tag
      id: extract_version
      if: steps.validate_tag.outputs.should_publish == 'true'
      run: |
        TAG="${{ steps.trigger_type.outputs.tag }}"
        # Extract the version number (e.g., 1.0.3 from 1.0.3 or 1.0.3-alpha)
        VERSION=$(echo "$TAG" | grep -oE '^[0-9]+\.[0-9]+\.[0-9]+')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Check version consistency with package.json
      if: steps.validate_tag.outputs.should_publish == 'true' && steps.trigger_type.outputs.is_tag == 'true'
      run: |
        TAG_VERSION="${{ steps.extract_version.outputs.version }}"
        PACKAGE_VERSION=$(node -p "require('./package.json').version")
        
        echo "Tag version: $TAG_VERSION"
        echo "package.json version: $PACKAGE_VERSION"
        
        if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
          echo "Error: Tag version ($TAG_VERSION) does not match package.json version ($PACKAGE_VERSION)"
          exit 1
        fi
        
        echo "Version check passed: $TAG_VERSION"

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22.x

    - name: Install dependencies
      run: npm install

    - name: Build
      run: npx tsc

    - name: Install VSCE
      run: npm install -g @vscode/vsce

    - name: Build VSIX
      run: vsce package

    - name: Check if version exists in VS Code Marketplace
      id: check_marketplace
      if: steps.validate_tag.outputs.should_publish == 'true'
      continue-on-error: true
      run: |
        EXTENSION_ID="royenheart.ege"
        VERSION="${{ steps.extract_version.outputs.version }}"
        
        echo "Checking if version $VERSION exists in VS Code Marketplace..."
        
        # Query the marketplace API
        RESPONSE=$(curl -s "https://marketplace.visualstudio.com/_apis/public/gallery/extensionquery" \
          -H "Content-Type: application/json" \
          -H "Accept: application/json;api-version=3.0-preview.1" \
          -d "{\"filters\":[{\"criteria\":[{\"filterType\":7,\"value\":\"$EXTENSION_ID\"}]}],\"flags\":914}")
        
        # Check if the specific version exists
        VERSION_EXISTS=$(echo "$RESPONSE" | grep -o "\"version\":\"$VERSION\"" || echo "")
        
        if [ -n "$VERSION_EXISTS" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "⚠️ Warning: Version $VERSION already exists in VS Code Marketplace"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "✓ Version $VERSION does not exist in VS Code Marketplace"
        fi

    - name: Warn if version exists (dry-run)
      if: steps.trigger_type.outputs.is_dry_run == 'true' && steps.validate_tag.outputs.should_publish == 'true' && steps.check_marketplace.outputs.exists == 'true'
      run: |
        echo "::warning::Version ${{ steps.extract_version.outputs.version }} already exists in VS Code Marketplace. If you create a tag for this version, the marketplace publish will be skipped."

    - name: Publish to VS Code Marketplace
      id: publish_marketplace
      if: steps.validate_tag.outputs.should_publish == 'true' && steps.trigger_type.outputs.is_dry_run == 'false'
      continue-on-error: true
      env:
        VSCE_PAT: ${{ secrets.MS_STORE_TOKEN }}
      run: |
        set +e  # Don't exit on error
        if [ "${{ steps.validate_tag.outputs.is_stable_release }}" == "true" ]; then
          echo "Publishing as stable release to VS Code Marketplace..."
          vsce publish -p $VSCE_PAT 2>&1 | tee publish_output.txt
        else
          echo "Publishing as pre-release to VS Code Marketplace..."
          vsce publish --pre-release -p $VSCE_PAT 2>&1 | tee publish_output.txt
        fi
        echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        exit ${PIPESTATUS[0]}

    - name: Check marketplace publish result
      if: steps.validate_tag.outputs.should_publish == 'true' && steps.trigger_type.outputs.is_dry_run == 'false'
      run: |
        if [ "${{ steps.publish_marketplace.outcome }}" == "failure" ]; then
          # Check if the error output contains "already exists"
          if [ -f publish_output.txt ] && grep -q "already exists" publish_output.txt; then
            echo "::warning::Version ${{ steps.extract_version.outputs.version }} already exists in VS Code Marketplace. This version may have been published manually. Skipping marketplace publish."
          else
            echo "::error::Failed to publish to VS Code Marketplace for an unknown reason."
            if [ -f publish_output.txt ]; then
              echo "Error details:"
              cat publish_output.txt
            fi
            exit 1
          fi
        else
          echo "✓ Successfully published to VS Code Marketplace"
        fi

    - name: Upload VSIX as artifact (dry-run)
      if: steps.trigger_type.outputs.is_dry_run == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: vscode-ege-${{ steps.trigger_type.outputs.tag }}
        path: ./*.vsix
        retention-days: 30

    - name: Create GitHub Release
      if: steps.validate_tag.outputs.should_publish == 'true' && steps.trigger_type.outputs.is_dry_run == 'false'
      uses: softprops/action-gh-release@v2
      with:
        files: ./*.vsix
        prerelease: ${{ steps.validate_tag.outputs.is_prerelease }}
        generate_release_notes: true